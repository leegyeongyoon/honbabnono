name: Check AWS Costs

on:
  schedule:
    - cron: '0 9 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2

jobs:
  cost-check:
    name: Check AWS Costs
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Get current month costs
      id: current-costs
      run: |
        START_DATE=$(date -d "$(date +%Y-%m-01)" +%Y-%m-%d)
        END_DATE=$(date +%Y-%m-%d)
        
        COST=$(aws ce get-cost-and-usage \
          --time-period Start=$START_DATE,End=$END_DATE \
          --granularity MONTHLY \
          --metrics BlendedCost \
          --group-by Type=DIMENSION,Key=SERVICE \
          --query 'ResultsByTime[0].Total.BlendedCost.Amount' \
          --output text)
        
        echo "current_cost=$COST" >> $GITHUB_OUTPUT
        
    - name: Get last month costs
      id: last-costs
      run: |
        LAST_MONTH_START=$(date -d "$(date +%Y-%m-01) -1 month" +%Y-%m-%d)
        LAST_MONTH_END=$(date -d "$(date +%Y-%m-01) -1 day" +%Y-%m-%d)
        
        LAST_COST=$(aws ce get-cost-and-usage \
          --time-period Start=$LAST_MONTH_START,End=$LAST_MONTH_END \
          --granularity MONTHLY \
          --metrics BlendedCost \
          --query 'ResultsByTime[0].Total.BlendedCost.Amount' \
          --output text)
        
        echo "last_cost=$LAST_COST" >> $GITHUB_OUTPUT
        
    - name: Cost analysis
      run: |
        echo "ğŸ“Š AWS ë¹„ìš© ë¦¬í¬íŠ¸"
        echo "===================="
        echo "ğŸ’° í˜„ì¬ ì›” ë¹„ìš©: $$${{ steps.current-costs.outputs.current_cost }}"
        echo "ğŸ“ˆ ì§€ë‚œ ì›” ë¹„ìš©: $$${{ steps.last-costs.outputs.last_cost }}"
        echo ""
        echo "ğŸ¯ ëª©í‘œ ì›” ë¹„ìš©: $26 (35,000ì›)"
        echo ""
        
        CURRENT=$(echo "${{ steps.current-costs.outputs.current_cost }}" | cut -d. -f1)
        if [ "$CURRENT" -gt 30 ]; then
          echo "âš ï¸  ë¹„ìš©ì´ ëª©í‘œì¹˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!"
          echo "ğŸ’¡ ë¹„ìš© ì ˆê° ë°©ë²•:"
          echo "   - ECS ì„œë¹„ìŠ¤ ìŠ¤ì¼€ì¼ ë‹¤ìš´: aws ecs update-service --desired-count 0"
          echo "   - ë¶ˆí•„ìš”í•œ ë¦¬ì†ŒìŠ¤ í™•ì¸"
        else
          echo "âœ… ë¹„ìš©ì´ ëª©í‘œ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤."
        fi