<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§€ì—­ ì„¤ì •</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html {
            width: 100%; height: 100%; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* ì§€ë„ ì˜ì—­ */
        #map {
            width: 100%;
            height: 100%;
        }

        /* ìƒë‹¨ ê²€ìƒ‰ ì˜ì—­ */
        .search-container {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 12px 16px;
            padding-top: max(12px, env(safe-area-inset-top));
            background: linear-gradient(to bottom, rgba(255,255,255,0.98), rgba(255,255,255,0.9));
            z-index: 1000;
        }
        .search-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
            text-align: center;
        }
        .search-box {
            display: flex;
            gap: 8px;
        }
        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 15px;
            background: white;
            outline: none;
        }
        .search-input:focus {
            border-color: #FE6847;
        }
        .search-btn {
            padding: 12px 16px;
            background: #FE6847;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        .search-btn:active {
            background: #e55a3c;
        }

        /* ê²€ìƒ‰ ê²°ê³¼ */
        .search-results {
            position: absolute;
            top: 100px;
            left: 16px;
            right: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }
        .search-result-item {
            padding: 14px 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-item:active {
            background: #f8f8f8;
        }
        .search-result-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        .search-result-address {
            font-size: 13px;
            color: #888;
        }

        /* ë°˜ê²½ ì„ íƒ ë²„íŠ¼ */
        .radius-selector {
            position: absolute;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        }
        .radius-btn {
            padding: 10px 14px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #f5f5f5;
            color: #666;
        }
        .radius-btn.active {
            background: #FE6847;
            color: white;
        }
        .radius-btn:active {
            transform: scale(0.95);
        }

        /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ */
        .current-location-btn {
            position: absolute;
            right: 16px;
            bottom: 200px;
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: none;
            font-size: 22px;
            cursor: pointer;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .current-location-btn:active {
            background: #f5f5f5;
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: white;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            border-radius: 24px 24px 0 0;
        }

        .location-info {
            margin-bottom: 16px;
        }
        .location-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 4px;
        }
        .location-detail {
            font-size: 14px;
            color: #888;
        }
        .radius-info {
            display: inline-block;
            background: #FE6847;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .button-group {
            display: flex;
            gap: 12px;
        }
        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-primary {
            background: #FE6847;
            color: white;
        }
        .btn-primary:active {
            background: #e55a3c;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:active {
            background: #e0e0e0;
        }

        /* ë¡œë”© */
        .loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #FE6847;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading p {
            margin-top: 16px;
            color: #666;
            font-size: 16px;
        }

        /* ì¤‘ì•™ ë§ˆì»¤ */
        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            pointer-events: none;
            font-size: 48px;
            margin-top: -24px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ìƒë‹¨ ê²€ìƒ‰ ì˜ì—­ -->
    <div class="search-container">
        <div class="search-title">ë‚´ í™œë™ ì§€ì—­ ì„¤ì •</div>
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="ì§€ì—­ëª…, ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ì—­, í™ëŒ€)" />
            <button class="search-btn" onclick="searchLocation()">ê²€ìƒ‰</button>
        </div>
    </div>

    <!-- ê²€ìƒ‰ ê²°ê³¼ -->
    <div class="search-results" id="searchResults"></div>

    <!-- ë°˜ê²½ ì„ íƒ -->
    <div class="radius-selector">
        <button class="radius-btn" data-radius="3" onclick="setRadius(3)">3km</button>
        <button class="radius-btn" data-radius="5" onclick="setRadius(5)">5km</button>
        <button class="radius-btn active" data-radius="10" onclick="setRadius(10)">10km</button>
        <button class="radius-btn" data-radius="30" onclick="setRadius(30)">30km</button>
    </div>

    <div id="map"></div>
    <div class="center-marker">ğŸ“</div>

    <button class="current-location-btn" onclick="getCurrentLocation()">ğŸ¯</button>

    <!-- í•˜ë‹¨ íŒ¨ë„ -->
    <div class="control-panel">
        <div class="location-info">
            <div class="location-title" id="locationTitle">ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            <div class="location-detail" id="locationDetail">ì§€ë„ë¥¼ ì›€ì§ì´ê±°ë‚˜ ê²€ìƒ‰í•˜ì„¸ìš”</div>
            <div class="radius-info" id="radiusInfo">ë°˜ê²½ 10km</div>
        </div>
        <div class="button-group">
            <button class="btn btn-secondary" onclick="closeMap()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="selectLocation()">ì´ ì§€ì—­ìœ¼ë¡œ ì„¤ì •</button>
        </div>
    </div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5a202bd90ab8dff01348f24cb1c37f3f&libraries=services&autoload=false"></script>
    <script>
        let map, geocoder, circle, places;
        let currentRadius = 10; // km
        let gpsAttempted = false;
        let currentLocation = {
            lat: 37.4979,  // ê°•ë‚¨ì—­ ê¸°ë³¸ ìœ„ì¹˜
            lng: 127.0276,
            district: 'ê°•ë‚¨êµ¬',
            neighborhood: 'ì—­ì‚¼ë™',
            address: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™'
        };

        // React Nativeë¡œ ë©”ì‹œì§€ ì „ì†¡
        function sendMessage(type, data) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ type, data }));
            }
            console.log('sendMessage:', type, data);
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            console.log('ğŸ—ºï¸ initMap ì‹œì‘');
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
                level: getMapLevel(currentRadius)
            };

            map = new kakao.maps.Map(container, options);
            geocoder = new kakao.maps.services.Geocoder();
            places = new kakao.maps.services.Places();
            console.log('ğŸ—ºï¸ ì§€ë„ ìƒì„± ì™„ë£Œ');

            // ë°˜ê²½ ì› ìƒì„±
            circle = new kakao.maps.Circle({
                center: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
                radius: currentRadius * 1000, // m ë‹¨ìœ„
                strokeWeight: 3,
                strokeColor: '#FE6847',
                strokeOpacity: 1,
                strokeStyle: 'solid',
                fillColor: '#FE6847',
                fillOpacity: 0.15
            });
            circle.setMap(map);
            console.log('ğŸ”´ ë°˜ê²½ ì› ìƒì„± ì™„ë£Œ, ë°˜ê²½:', currentRadius, 'km');

            // ë“œë˜ê·¸ ì¢…ë£Œ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(map, 'dragend', function() {
                updateLocation();
            });

            // ì¤Œ ë³€ê²½ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(map, 'zoom_changed', function() {
                updateCircle();
            });

            // ê²€ìƒ‰ ì…ë ¥ ì—”í„° í‚¤ ì´ë²¤íŠ¸
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });

            // ê²€ìƒ‰ ì…ë ¥ í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container') && !e.target.closest('.search-results')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });

            // React Native WebViewì¸ ê²½ìš° React Nativeì—ì„œ GPS ì¢Œí‘œë¥¼ ì „ì†¡í•´ì¤„ ê²ƒì´ë¯€ë¡œ
            // WebView ìì²´ GPSëŠ” í˜¸ì¶œí•˜ì§€ ì•ŠìŒ (iOS WebView GPS ë¬¸ì œ í•´ê²°)
            if (window.ReactNativeWebView) {
                console.log('ğŸ“ React Native WebView ê°ì§€ - GPS ì¢Œí‘œ ìˆ˜ì‹  ëŒ€ê¸°');
                // ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì—­ì§€ì˜¤ì½”ë”© ë¨¼ì € ìˆ˜í–‰ (React Native ì¢Œí‘œê°€ ì˜¤ë©´ ë®ì–´ì”€)
                const latlng = new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng);
                reverseGeocode(latlng);
            } else {
                // ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì—´ë¦° ê²½ìš° WebView GPS ì‚¬ìš©
                getCurrentLocation();
            }

            document.getElementById('loading').style.display = 'none';
            sendMessage('MAP_READY', { status: 'ready' });
        }

        // ë°˜ê²½ì— ë”°ë¥¸ ì§€ë„ ë ˆë²¨ (ì¤‘ê°„ê°’ìœ¼ë¡œ ì¡°ì •)
        function getMapLevel(radius) {
            if (radius <= 3) return 7;   // 3km ë°˜ê²½
            if (radius <= 5) return 8;   // 5km ë°˜ê²½
            if (radius <= 10) return 9;  // 10km ë°˜ê²½
            return 11; // 30km ë°˜ê²½
        }

        // ì§€ì—­ ê²€ìƒ‰
        function searchLocation() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) return;

            // í‚¤ì›Œë“œë¡œ ì¥ì†Œ ê²€ìƒ‰
            places.keywordSearch(keyword, function(result, status) {
                const resultsDiv = document.getElementById('searchResults');

                if (status === kakao.maps.services.Status.OK) {
                    resultsDiv.innerHTML = '';
                    resultsDiv.style.display = 'block';

                    // ìµœëŒ€ 5ê°œ ê²°ê³¼ í‘œì‹œ
                    const items = result.slice(0, 5);
                    items.forEach(function(place) {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.innerHTML = `
                            <div class="search-result-name">${place.place_name}</div>
                            <div class="search-result-address">${place.address_name}</div>
                        `;
                        item.onclick = function() {
                            moveToLocation(place.y, place.x, place.address_name, place.place_name);
                            resultsDiv.style.display = 'none';
                            document.getElementById('searchInput').value = place.place_name;
                        };
                        resultsDiv.appendChild(item);
                    });
                } else {
                    // ì£¼ì†Œë¡œ ê²€ìƒ‰ ì‹œë„
                    geocoder.addressSearch(keyword, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            resultsDiv.innerHTML = '';
                            resultsDiv.style.display = 'block';

                            result.slice(0, 5).forEach(function(addr) {
                                const item = document.createElement('div');
                                item.className = 'search-result-item';
                                item.innerHTML = `
                                    <div class="search-result-name">${addr.address_name}</div>
                                    <div class="search-result-address">${addr.address?.region_2depth_name || ''} ${addr.address?.region_3depth_name || ''}</div>
                                `;
                                item.onclick = function() {
                                    moveToLocation(addr.y, addr.x, addr.address_name, '');
                                    resultsDiv.style.display = 'none';
                                    document.getElementById('searchInput').value = addr.address_name;
                                };
                                resultsDiv.appendChild(item);
                            });
                        } else {
                            resultsDiv.innerHTML = '<div class="search-result-item"><div class="search-result-name">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div></div>';
                            resultsDiv.style.display = 'block';
                        }
                    });
                }
            });
        }

        // íŠ¹ì • ìœ„ì¹˜ë¡œ ì´ë™
        function moveToLocation(lat, lng, address, name) {
            const latlng = new kakao.maps.LatLng(lat, lng);
            map.setCenter(latlng);
            map.setLevel(getMapLevel(currentRadius));

            currentLocation.lat = parseFloat(lat);
            currentLocation.lng = parseFloat(lng);
            currentLocation.address = address;

            circle.setPosition(latlng);
            reverseGeocode(latlng);
        }

        // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateLocation() {
            const center = map.getCenter();
            currentLocation.lat = center.getLat();
            currentLocation.lng = center.getLng();

            // ì› ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            circle.setPosition(center);

            // ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
            reverseGeocode(center);
        }

        // ì› ì—…ë°ì´íŠ¸
        function updateCircle() {
            const center = map.getCenter();
            circle.setPosition(center);
        }

        // ë°˜ê²½ ì„¤ì •
        function setRadius(radius) {
            currentRadius = radius;

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.radius-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.radius) === radius) {
                    btn.classList.add('active');
                }
            });

            // ì› ë°˜ê²½ ì—…ë°ì´íŠ¸
            circle.setRadius(radius * 1000);

            // ì§€ë„ ë ˆë²¨ ì¡°ì •
            map.setLevel(getMapLevel(radius));

            // ë°˜ê²½ ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('radiusInfo').textContent = `ë°˜ê²½ ${radius}km`;
        }

        // ì¢Œí‘œ -> ì£¼ì†Œ ë³€í™˜
        function reverseGeocode(coords) {
            geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK && result[0]) {
                    const addr = result[0];
                    const address = addr.road_address ? addr.road_address.address_name : addr.address.address_name;

                    currentLocation.address = address;
                    currentLocation.district = addr.address ? addr.address.region_2depth_name : '';
                    currentLocation.neighborhood = addr.address ? addr.address.region_3depth_name : '';

                    // UI ì—…ë°ì´íŠ¸
                    const title = currentLocation.district + (currentLocation.neighborhood ? ' ' + currentLocation.neighborhood : '');
                    document.getElementById('locationTitle').textContent = title || 'ì•Œ ìˆ˜ ì—†ëŠ” ì§€ì—­';
                    document.getElementById('locationDetail').textContent = address;
                }
            });
        }

        // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° (WebView ìì²´ GPS - ëŒ€ì²´ìš©)
        function getCurrentLocation() {
            console.log('ğŸ“ GPS ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹œë„...');
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(pos) {
                        console.log('ğŸ“ GPS ì„±ê³µ:', pos.coords.latitude, pos.coords.longitude);
                        gpsAttempted = true;
                        const latlng = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                        map.setCenter(latlng);
                        currentLocation.lat = pos.coords.latitude;
                        currentLocation.lng = pos.coords.longitude;
                        circle.setPosition(latlng);
                        reverseGeocode(latlng);
                        sendMessage('GPS_LOCATION', { lat: pos.coords.latitude, lng: pos.coords.longitude });
                    },
                    function(error) {
                        console.log('ğŸ“ GPS ì‹¤íŒ¨:', error.code, error.message);
                        gpsAttempted = true;
                        // ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ìœ„ì¹˜(ê°•ë‚¨ì—­)ë¡œ ì—­ì§€ì˜¤ì½”ë”© ìˆ˜í–‰
                        const latlng = new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng);
                        reverseGeocode(latlng);
                        sendMessage('GPS_ERROR', { code: error.code, message: error.message });
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                console.log('ğŸ“ Geolocation API ì§€ì› ì•ˆ í•¨');
                gpsAttempted = true;
                // API ì§€ì› ì•ˆ í•˜ë©´ ê¸°ë³¸ ìœ„ì¹˜ë¡œ
                const latlng = new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng);
                reverseGeocode(latlng);
            }
        }

        // React Nativeì—ì„œ GPS ì¢Œí‘œ ìˆ˜ì‹  (iOS WebView GPS ë¬¸ì œ í•´ê²°ìš©)
        function setLocationFromNative(lat, lng) {
            console.log('ğŸ“ React Nativeì—ì„œ ì¢Œí‘œ ìˆ˜ì‹ :', lat, lng);

            // í•œêµ­ ë²”ìœ„ ì²´í¬ (ìœ„ë„: 33~43, ê²½ë„: 124~132)
            // ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ì„œìš¸ ì‹œì²­ ì¢Œí‘œë¡œ ëŒ€ì²´
            const isInKorea = lat >= 33 && lat <= 43 && lng >= 124 && lng <= 132;
            if (!isInKorea) {
                console.log('ğŸ“ í•œêµ­ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨, ì„œìš¸ ì‹œì²­ ì¢Œí‘œë¡œ ëŒ€ì²´');
                lat = 37.5665;  // ì„œìš¸ ì‹œì²­ ìœ„ë„
                lng = 126.9780; // ì„œìš¸ ì‹œì²­ ê²½ë„
            }

            if (!map || !circle) {
                console.log('ğŸ“ ì§€ë„ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ, ì¢Œí‘œ ì €ì¥ë§Œ');
                currentLocation.lat = lat;
                currentLocation.lng = lng;
                return;
            }

            const latlng = new kakao.maps.LatLng(lat, lng);
            map.setCenter(latlng);
            currentLocation.lat = lat;
            currentLocation.lng = lng;
            circle.setPosition(latlng);
            reverseGeocode(latlng);
            sendMessage('GPS_LOCATION', { lat: lat, lng: lng });
        }

        // ìœ„ì¹˜ ì„ íƒ ì™„ë£Œ
        function selectLocation() {
            // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
            if (!currentLocation.lat || !currentLocation.lng) {
                alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('ğŸ“ ìœ„ì¹˜ ì„ íƒ ì „ì†¡:', currentLocation);
            sendMessage('LOCATION_SELECTED', {
                latitude: currentLocation.lat,
                longitude: currentLocation.lng,
                address: currentLocation.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ',
                district: currentLocation.district || '',
                neighborhood: currentLocation.neighborhood || '',
                radius: currentRadius
            });
        }

        // ë‹«ê¸°
        function closeMap() {
            sendMessage('CLOSE_MAP', {});
        }

        // ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ
        kakao.maps.load(initMap);
    </script>
</body>
</html>
