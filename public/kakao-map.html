<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì¹´ì˜¤ ì§€ë„</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100vh;
        }
        
        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn {
            background: #fff;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 14px;
            min-width: 80px;
        }
        
        .btn:hover {
            background: #f5f5f5;
        }
        
        .address-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .address-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .address-text {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>ğŸ—ºï¸</div>
        <div>ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    
    <div id="map"></div>
    
    <div class="controls">
        <button id="currentLocationBtn" class="btn">ğŸ“ í˜„ì¬ìœ„ì¹˜</button>
        <button id="confirmBtn" class="btn" style="background: #3182f6; color: white;">ì„ íƒì™„ë£Œ</button>
    </div>
    
    <div id="addressInfo" class="address-info" style="display: none;">
        <div class="address-title">ì„ íƒëœ ìœ„ì¹˜</div>
        <div id="addressText" class="address-text">ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
    </div>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9d1ee4bec9bd24d0ac9f8c9d68fbf432&libraries=services"></script>
    <script>
        console.log('ğŸ—ºï¸ ì¹´ì¹´ì˜¤ ë§µ HTML í˜ì´ì§€ ì‹œì‘');
        
        let map;
        let marker;
        let geocoder;
        let selectedLocation = null;
        
        // React Native WebViewì™€ í†µì‹ í•˜ëŠ” í•¨ìˆ˜
        function sendMessageToApp(data) {
            console.log('ğŸ“± ì•±ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡:', data);
            
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify(data));
            }
            
            // ì›¹ í™˜ê²½ì—ì„œëŠ” ìƒìœ„ windowë¡œ ë©”ì‹œì§€ ì „ì†¡
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(data, '*');
            }
        }
        
        // ì£¼ì†Œ ë³€í™˜ í•¨ìˆ˜
        function searchAddrFromCoords(coords, callback) {
            geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const detailAddr = result[0];
                    const fullAddress = detailAddr.road_address ? 
                        detailAddr.road_address.address_name : 
                        detailAddr.address.address_name;
                    
                    callback(fullAddress);
                } else {
                    callback('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            });
        }
        
        // ìœ„ì¹˜ ì„ íƒ ì²˜ë¦¬
        function selectLocation(lat, lng, address) {
            selectedLocation = {
                latitude: lat,
                longitude: lng,
                address: address
            };
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('addressInfo').style.display = 'block';
            document.getElementById('addressText').textContent = address;
            
            console.log('âœ… ìœ„ì¹˜ ì„ íƒë¨:', selectedLocation);
        }
        
        // ì§€ë„ ì´ˆê¸°í™”
        function initializeMap() {
            try {
                console.log('ğŸ—ºï¸ ì§€ë„ ì´ˆê¸°í™” ì‹œì‘...');
                
                // ë¡œë”© ìˆ¨ê¸°ê¸°
                document.getElementById('loading').style.display = 'none';
                
                // ì§€ì˜¤ì½”ë” ìƒì„±
                geocoder = new kakao.maps.services.Geocoder();
                
                // ì§€ë„ ì˜µì…˜
                const mapContainer = document.getElementById('map');
                const mapOption = {
                    center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­
                    level: 3
                };
                
                // ì§€ë„ ìƒì„±
                map = new kakao.maps.Map(mapContainer, mapOption);
                
                // ë§ˆì»¤ ìƒì„±
                marker = new kakao.maps.Marker({
                    position: mapOption.center,
                    draggable: true
                });
                marker.setMap(map);
                
                // ì´ˆê¸° ìœ„ì¹˜ ì£¼ì†Œ ê²€ìƒ‰
                searchAddrFromCoords(mapOption.center, function(address) {
                    selectLocation(37.5665, 126.9780, address);
                });
                
                // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                    const latlng = mouseEvent.latLng;
                    
                    // ë§ˆì»¤ ì´ë™
                    marker.setPosition(latlng);
                    
                    // ì£¼ì†Œ ê²€ìƒ‰
                    searchAddrFromCoords(latlng, function(address) {
                        selectLocation(latlng.getLat(), latlng.getLng(), address);
                    });
                });
                
                // ë§ˆì»¤ ë“œë˜ê·¸ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(marker, 'dragend', function() {
                    const latlng = marker.getPosition();
                    
                    searchAddrFromCoords(latlng, function(address) {
                        selectLocation(latlng.getLat(), latlng.getLng(), address);
                    });
                });
                
                console.log('âœ… ì¹´ì¹´ì˜¤ ë§µ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ì•±ì— ì´ˆê¸°í™” ì™„ë£Œ ì•Œë¦¼
                sendMessageToApp({
                    type: 'MAP_READY',
                    message: 'ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ'
                });
                
            } catch (error) {
                console.error('âŒ ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                
                // ì—ëŸ¬ë¥¼ ì•±ì— ì•Œë¦¼
                sendMessageToApp({
                    type: 'MAP_ERROR',
                    error: error.message
                });
            }
        }
        
        // í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
        function moveToCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const moveLatLng = new kakao.maps.LatLng(lat, lng);
                    
                    map.setCenter(moveLatLng);
                    marker.setPosition(moveLatLng);
                    
                    searchAddrFromCoords(moveLatLng, function(address) {
                        selectLocation(lat, lng, address);
                    });
                    
                }, function(error) {
                    console.error('GPS ì˜¤ë¥˜:', error);
                    alert('í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                });
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìœ„ì¹˜ ì„ íƒ í™•ì¸
        function confirmLocation() {
            if (selectedLocation) {
                console.log('âœ… ìœ„ì¹˜ ì„ íƒ í™•ì •:', selectedLocation);
                
                sendMessageToApp({
                    type: 'LOCATION_SELECTED',
                    data: selectedLocation
                });
            } else {
                alert('ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ—ºï¸ DOM ë¡œë“œ ì™„ë£Œ, ì¹´ì¹´ì˜¤ ë§µ ì´ˆê¸°í™” ëŒ€ê¸°...');
            
            // ì¹´ì¹´ì˜¤ ë§µ SDK ë¡œë“œ í™•ì¸
            if (window.kakao && window.kakao.maps) {
                initializeMap();
            } else {
                // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ëŒ€ê¸°
                const checkKakao = setInterval(() => {
                    if (window.kakao && window.kakao.maps) {
                        clearInterval(checkKakao);
                        initializeMap();
                    }
                }, 100);
                
                // 10ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ
                setTimeout(() => {
                    clearInterval(checkKakao);
                    console.error('âŒ ì¹´ì¹´ì˜¤ ë§µ SDK ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
                    sendMessageToApp({
                        type: 'MAP_ERROR',
                        error: 'ì¹´ì¹´ì˜¤ ë§µì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
                    });
                }, 10000);
            }
            
            // ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('currentLocationBtn').addEventListener('click', moveToCurrentLocation);
            document.getElementById('confirmBtn').addEventListener('click', confirmLocation);
        });
        
        // ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥í•œ í•¨ìˆ˜ë“¤
        window.moveToLocation = function(lat, lng) {
            if (map && marker) {
                const latlng = new kakao.maps.LatLng(lat, lng);
                map.setCenter(latlng);
                marker.setPosition(latlng);
                
                searchAddrFromCoords(latlng, function(address) {
                    selectLocation(lat, lng, address);
                });
            }
        };
        
        window.getCurrentSelection = function() {
            return selectedLocation;
        };
        
    </script>
</body>
</html>