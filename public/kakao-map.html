<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì¹´ì¹´ì˜¤ë§µ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { 
            width: 100%; 
            height: 100%; 
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        #map { 
            width: 100%; 
            height: calc(100% - 120px); 
            position: relative;
        }
        .control-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .address-display {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            min-height: 45px;
            display: flex;
            align-items: center;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #FE6847;
            color: white;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1001;
        }
        .loading-spinner {
            font-size: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .current-location-btn {
            position: absolute;
            right: 10px;
            bottom: 140px;
            width: 44px;
            height: 44px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
        }
        .current-location-btn:active {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner">ğŸ—ºï¸</div>
        <p style="margin-top: 10px; color: #666;">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
    
    <div id="map"></div>
    
    <button class="current-location-btn" onclick="getCurrentLocation()">
        ğŸ“
    </button>
    
    <div class="control-panel">
        <div class="address-display" id="address">
            ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”
        </div>
        <div class="button-group">
            <button class="btn btn-secondary" onclick="closeMap()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="selectLocation()">ì„ íƒì™„ë£Œ</button>
        </div>
    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=9d1ee4bec9bd24d0ac9f8c9d68fbf432&libraries=services&autoload=false"></script>
    <script>
        let map = null;
        let marker = null;
        let geocoder = null;
        let currentLocation = {
            lat: 37.5665,
            lng: 126.9780,
            address: 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ íƒœí‰ë¡œ1ê°€'
        };

        // React Native ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        function sendMessage(type, data) {
            try {
                if (window.ReactNativeWebView) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type, data }));
                } else {
                    console.log('WebView ë©”ì‹œì§€:', { type, data });
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
            }
        }

        // React Nativeë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
        window.addEventListener('message', function(event) {
            try {
                const message = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                if (message.type === 'SET_INITIAL_LOCATION') {
                    if (message.latitude && message.longitude) {
                        currentLocation.lat = message.latitude;
                        currentLocation.lng = message.longitude;
                        if (map && marker) {
                            const position = new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng);
                            map.setCenter(position);
                            marker.setPosition(position);
                            searchAddress(currentLocation.lat, currentLocation.lng);
                        }
                    }
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            }
        });

        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
        window.onload = function() {
            console.log('ğŸ”„ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì‹œì‘...');
            
            // kakao ê°ì²´ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
            if (typeof kakao === 'undefined' || !kakao.maps) {
                console.error('âŒ ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ ì‹¤íŒ¨');
                sendMessage('MAP_ERROR', { error: 'ì¹´ì¹´ì˜¤ë§µ SDKë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' });
                document.getElementById('loading').innerHTML = '<div style="color: red; padding: 20px;">âš ï¸ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
                return;
            }

            // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
            kakao.maps.load(function() {
            try {
                // ì§€ë„ ì»¨í…Œì´ë„ˆ
                const container = document.getElementById('map');
                
                // ì§€ë„ ì˜µì…˜
                const options = {
                    center: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
                    level: 3
                };

                // ì§€ë„ ìƒì„±
                map = new kakao.maps.Map(container, options);

                // ë§ˆì»¤ ìƒì„±
                marker = new kakao.maps.Marker({
                    position: map.getCenter(),
                    draggable: true
                });
                marker.setMap(map);

                // ì§€ì˜¤ì½”ë” ìƒì„±
                geocoder = new kakao.maps.services.Geocoder();

                // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                    const latlng = mouseEvent.latLng;
                    marker.setPosition(latlng);
                    currentLocation.lat = latlng.getLat();
                    currentLocation.lng = latlng.getLng();
                    searchAddress(currentLocation.lat, currentLocation.lng);
                });

                // ë§ˆì»¤ ë“œë˜ê·¸ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(marker, 'dragend', function() {
                    const position = marker.getPosition();
                    currentLocation.lat = position.getLat();
                    currentLocation.lng = position.getLng();
                    searchAddress(currentLocation.lat, currentLocation.lng);
                });

                // ì´ˆê¸° ì£¼ì†Œ ê²€ìƒ‰
                searchAddress(currentLocation.lat, currentLocation.lng);

                // ë¡œë”© ì™„ë£Œ
                document.getElementById('loading').style.display = 'none';
                sendMessage('MAP_READY', { status: 'ready' });

            } catch (error) {
                console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                sendMessage('MAP_ERROR', { error: error.message });
            }
        });
        };

        // ì£¼ì†Œ ê²€ìƒ‰
        function searchAddress(lat, lng) {
            if (!geocoder) return;

            geocoder.coord2Address(lng, lat, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const address = result[0].address.address_name;
                    const roadAddress = result[0].road_address ? result[0].road_address.address_name : address;
                    
                    currentLocation.address = address;
                    currentLocation.roadAddress = roadAddress;
                    
                    document.getElementById('address').textContent = roadAddress || address;
                } else {
                    document.getElementById('address').textContent = `ìœ„ì¹˜: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                }
            });
        }

        // í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const locPosition = new kakao.maps.LatLng(lat, lng);
                    
                    map.setCenter(locPosition);
                    marker.setPosition(locPosition);
                    
                    currentLocation.lat = lat;
                    currentLocation.lng = lng;
                    searchAddress(lat, lng);
                }, function(error) {
                    alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    console.error('ìœ„ì¹˜ ì˜¤ë¥˜:', error);
                });
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        // ìœ„ì¹˜ ì„ íƒ
        function selectLocation() {
            sendMessage('LOCATION_SELECTED', {
                latitude: currentLocation.lat,
                longitude: currentLocation.lng,
                address: currentLocation.address,
                roadAddress: currentLocation.roadAddress,
                placeName: currentLocation.address
            });
        }

        // ì§€ë„ ë‹«ê¸°
        function closeMap() {
            sendMessage('CLOSE_MAP', {});
        }
    </script>
</body>
</html>