<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìœ„ì¹˜ ì„ íƒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }

        /* ê²€ìƒ‰ ì˜ì—­ */
        .search-container {
            position: absolute; top: 0; left: 0; right: 0;
            padding: 12px; padding-top: max(12px, env(safe-area-inset-top));
            background: white; z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-box {
            display: flex; gap: 8px;
        }
        .search-input {
            flex: 1; padding: 12px 16px;
            border: 1px solid #e0e0e0; border-radius: 10px;
            font-size: 15px; outline: none;
        }
        .search-input:focus {
            border-color: #FE6847;
        }
        .search-btn {
            padding: 12px 20px; background: #FE6847; color: white;
            border: none; border-radius: 10px; font-size: 15px;
            font-weight: 600; cursor: pointer;
        }
        .search-btn:active {
            background: #e55a3c;
        }

        /* ê²€ìƒ‰ ê²°ê³¼ */
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; max-height: 300px; overflow-y: auto;
            border-top: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        .search-results.show {
            display: block;
        }
        .result-item {
            padding: 14px 16px; border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .result-item:active {
            background: #f8f8f8;
        }
        .result-name {
            font-size: 15px; font-weight: 500; color: #333;
            margin-bottom: 4px;
        }
        .result-address {
            font-size: 13px; color: #888;
        }
        .no-results {
            padding: 20px; text-align: center; color: #888;
        }

        /* ì§€ë„ ì˜ì—­ */
        #map {
            width: 100%;
            height: calc(100% - 130px);
            margin-top: 60px;
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: white; padding: 15px;
            padding-bottom: max(15px, env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000;
        }
        .address-display {
            margin-bottom: 10px; padding: 12px; background: #f8f8f8;
            border-radius: 8px; font-size: 14px; color: #333;
            min-height: 48px; display: flex; align-items: center;
        }
        .place-name {
            font-weight: 600; color: #FE6847; margin-right: 8px;
        }
        .button-group { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #FE6847; color: white; }
        .btn-secondary { background: #f0f0f0; color: #333; }

        /* ë¡œë”© */
        .loading {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .loading-spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #FE6847; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ */
        .current-location-btn {
            position: absolute; right: 10px; bottom: 150px;
            width: 48px; height: 48px; background: white;
            border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            border: none; font-size: 24px; cursor: pointer; z-index: 999;
        }

        /* ì¤‘ì•™ ë§ˆì»¤ */
        .center-marker {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -100%);
            z-index: 100; pointer-events: none; font-size: 40px;
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p style="margin-top: 16px; color: #666;">ì¹´ì¹´ì˜¤ ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div class="search-container">
        <div class="search-box">
            <input type="text" class="search-input" id="searchInput"
                   placeholder="ì¥ì†Œëª… ë˜ëŠ” ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ì—­, ìŠ¤íƒ€ë²…ìŠ¤)"
                   onkeypress="handleKeyPress(event)">
            <button class="search-btn" onclick="searchPlace()">ê²€ìƒ‰</button>
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <div id="map"></div>
    <div class="center-marker">ğŸ“</div>
    <button class="current-location-btn" onclick="getCurrentLocation()">ğŸ“</button>

    <div class="control-panel">
        <div class="address-display" id="address">ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
        <div class="button-group">
            <button class="btn btn-secondary" onclick="closeMap()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" onclick="selectLocation()">ì„ íƒì™„ë£Œ</button>
        </div>
    </div>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5a202bd90ab8dff01348f24cb1c37f3f&libraries=services&autoload=false"></script>
    <script>
        let map, geocoder, places, marker;
        let currentLocation = {
            lat: 37.5665,
            lng: 126.9780,
            address: 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬',
            district: 'ì¤‘êµ¬',
            neighborhood: '',
            placeName: ''
        };

        function sendMessage(type, data) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify({ type, data }));
            }
        }

        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
                level: 3
            };
            map = new kakao.maps.Map(container, options);
            geocoder = new kakao.maps.services.Geocoder();
            places = new kakao.maps.services.Places();

            // ë§ˆì»¤ ìƒì„±
            marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng),
                map: map
            });

            // ë“œë˜ê·¸ ì¢…ë£Œ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(map, 'dragend', function() {
                const center = map.getCenter();
                currentLocation.lat = center.getLat();
                currentLocation.lng = center.getLng();
                currentLocation.placeName = '';
                marker.setPosition(center);
                reverseGeocode(center);
            });

            // í´ë¦­ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(map, 'click', function(e) {
                map.setCenter(e.latLng);
                currentLocation.lat = e.latLng.getLat();
                currentLocation.lng = e.latLng.getLng();
                currentLocation.placeName = '';
                marker.setPosition(e.latLng);
                reverseGeocode(e.latLng);
            });

            reverseGeocode(new kakao.maps.LatLng(currentLocation.lat, currentLocation.lng));
            getCurrentLocation();
            document.getElementById('loading').style.display = 'none';
            sendMessage('MAP_READY', { status: 'ready', mapType: 'kakao' });

            // ê²€ìƒ‰ì°½ ì™¸ë¶€ í´ë¦­ì‹œ ê²°ê³¼ ìˆ¨ê¹€
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideSearchResults();
                }
            });
        }

        // ì¢Œí‘œ -> ì£¼ì†Œ ë³€í™˜
        function reverseGeocode(coords) {
            geocoder.coord2Address(coords.getLng(), coords.getLat(), function(result, status) {
                if (status === kakao.maps.services.Status.OK && result[0]) {
                    const addr = result[0];
                    currentLocation.address = addr.road_address ? addr.road_address.address_name : addr.address.address_name;
                    currentLocation.district = addr.address ? addr.address.region_2depth_name : '';
                    currentLocation.neighborhood = addr.address ? addr.address.region_3depth_name : '';
                    updateAddressDisplay();
                }
            });
        }

        // ì£¼ì†Œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateAddressDisplay() {
            const addressEl = document.getElementById('address');
            if (currentLocation.placeName) {
                addressEl.innerHTML = '<span class="place-name">' + currentLocation.placeName + '</span>' + currentLocation.address;
            } else {
                addressEl.textContent = currentLocation.address;
            }
        }

        // ê²€ìƒ‰ ì‹¤í–‰
        function searchPlace() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            // í‚¤ì›Œë“œ ê²€ìƒ‰ (ê°€ê²Œëª…, ì¥ì†Œëª…)
            places.keywordSearch(query, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    showSearchResults(result);
                } else {
                    // í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹¤íŒ¨ì‹œ ì£¼ì†Œ ê²€ìƒ‰ ì‹œë„
                    geocoder.addressSearch(query, function(addrResult, addrStatus) {
                        if (addrStatus === kakao.maps.services.Status.OK) {
                            showAddressResults(addrResult);
                        } else {
                            showNoResults();
                        }
                    });
                }
            });
        }

        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                searchPlace();
            }
        }

        // í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function showSearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            results.slice(0, 10).forEach(function(place) {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML =
                    '<div class="result-name">' + place.place_name + '</div>' +
                    '<div class="result-address">' + (place.road_address_name || place.address_name) + '</div>';
                item.onclick = function() {
                    selectSearchResult(place);
                };
                container.appendChild(item);
            });

            container.classList.add('show');
        }

        // ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function showAddressResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            results.slice(0, 10).forEach(function(addr) {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML =
                    '<div class="result-name">' + (addr.road_address ? addr.road_address.address_name : addr.address_name) + '</div>' +
                    '<div class="result-address">' + addr.address_name + '</div>';
                item.onclick = function() {
                    selectAddressResult(addr);
                };
                container.appendChild(item);
            });

            container.classList.add('show');
        }

        // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ
        function showNoResults() {
            const container = document.getElementById('searchResults');
            container.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            container.classList.add('show');
        }

        // ê²€ìƒ‰ ê²°ê³¼ ìˆ¨ê¹€
        function hideSearchResults() {
            document.getElementById('searchResults').classList.remove('show');
        }

        // í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ
        function selectSearchResult(place) {
            const coords = new kakao.maps.LatLng(place.y, place.x);

            currentLocation.lat = parseFloat(place.y);
            currentLocation.lng = parseFloat(place.x);
            currentLocation.address = place.road_address_name || place.address_name;
            currentLocation.placeName = place.place_name;

            // êµ¬/ë™ ì •ë³´ ì¶”ì¶œ
            const addrParts = place.address_name.split(' ');
            currentLocation.district = addrParts[1] || '';
            currentLocation.neighborhood = addrParts[2] || '';

            map.setCenter(coords);
            map.setLevel(3);
            marker.setPosition(coords);
            updateAddressDisplay();
            hideSearchResults();
            document.getElementById('searchInput').value = '';
        }

        // ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ
        function selectAddressResult(addr) {
            const coords = new kakao.maps.LatLng(addr.y, addr.x);

            currentLocation.lat = parseFloat(addr.y);
            currentLocation.lng = parseFloat(addr.x);
            currentLocation.address = addr.road_address ? addr.road_address.address_name : addr.address_name;
            currentLocation.placeName = '';

            // êµ¬/ë™ ì •ë³´ ì¶”ì¶œ
            const addrParts = addr.address_name.split(' ');
            currentLocation.district = addrParts[1] || '';
            currentLocation.neighborhood = addrParts[2] || '';

            map.setCenter(coords);
            map.setLevel(3);
            marker.setPosition(coords);
            updateAddressDisplay();
            hideSearchResults();
            document.getElementById('searchInput').value = '';
        }

        // í˜„ì¬ ìœ„ì¹˜
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const latlng = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                    map.setCenter(latlng);
                    marker.setPosition(latlng);
                    currentLocation.lat = pos.coords.latitude;
                    currentLocation.lng = pos.coords.longitude;
                    currentLocation.placeName = '';
                    reverseGeocode(latlng);
                }, null, { enableHighAccuracy: true, timeout: 10000 });
            }
        }

        // ìœ„ì¹˜ ì„ íƒ ì™„ë£Œ
        function selectLocation() {
            sendMessage('LOCATION_SELECTED', {
                latitude: currentLocation.lat,
                longitude: currentLocation.lng,
                address: currentLocation.address,
                district: currentLocation.district,
                neighborhood: currentLocation.neighborhood,
                placeName: currentLocation.placeName
            });
        }

        // ë‹«ê¸°
        function closeMap() {
            sendMessage('CLOSE_MAP', {});
        }

        // ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ
        kakao.maps.load(initMap);
    </script>
</body>
</html>
